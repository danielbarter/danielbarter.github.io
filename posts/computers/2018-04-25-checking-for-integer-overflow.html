<!DOCTYPE html>
<html>
  <head>
    <title> Daniel Barter - checking for integer overflow</title>
    <link href="../../style.css" rel="stylesheet">

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>
  <body>
    <nav>
<a href="../../"> HOME </a>
<span> / </span>
<a href="../../CV.html"> CV </a>
<span> / </span>
<a href="../../publickey.html"> PUBKEY </a>
<span> / </span>
<a href="../../blog.html"> BLOG </a>
<span> / </span>
<a href="../../mix.html"> MIX1010 </a>
<span> / </span>
<a href="../../tableau.html"> TABLEAU </a>
</nav>

<h1 id="checking-for-integer-overflow">Checking for Integer Overflow</h1>
<p>When you are doing integer arithmetic on a computer, you need to worry about <a href="https://en.wikipedia.org/wiki/Integer_overflow">integer overflow</a>. If <code>x,y,z</code> are unsigned 64-bit integer variables, and we evaluate <code>z = x + y</code>, then integer overflow occurs exactly when <code>z &lt; x</code>, so we can check for overflow using an <code>if</code> statement. This approach is nice because you don't leave the world of C, so it is machine independent. If you are mindful of your hardware, then this approach is a little unsatisfying. For example, in the <code>x86_64</code> architecture, there is the <code>CF</code> flag which is set to <code>1</code> when an overflow occurs. Rather than comparing <code>z</code> and <code>x</code>, we could instead directly read the <code>CF</code> flag. You can do this with the following confusing code:</p>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#include </span><span class="im">&lt;limits.h&gt;</span>


<span class="dt">char</span> *add_overflow_flag_data = <span class="st">&quot;</span><span class="sc">\x48\x89\xf0\x48\x01\xd0\x0f\x92\x07\xc3</span><span class="st">&quot;</span>; <span class="co">// explained below</span>

<span class="dt">int</span> main (<span class="dt">void</span>) {

  <span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span> (*add_overflow_flag) (<span class="dt">int</span> *bp, <span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span> x, <span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span> y);       <span class="co">// declaring a function pointer</span>
  add_overflow_flag = (<span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span> (*) (<span class="dt">int</span> *, <span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span>, <span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span>)) add_overflow_flag_data; <span class="co">// initializing function pointer</span>
  <span class="dt">int</span> b = <span class="dv">0</span>;
  <span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span> s1 = (*add_overflow_flag)(&amp;b,<span class="dv">1</span>,<span class="dv">1</span>);  <span class="co">// b will be set to 0, s1 to 2</span>
  <span class="dt">long</span> <span class="dt">unsigned</span> <span class="dt">int</span> s2 = (*add_overflow_flag)(&amp;b,<span class="dv">3</span>,ULONG_MAX);  <span class="co">// b will be set to 1, s2 to 2</span>
  <span class="cf">return</span> <span class="dv">0</span>;
}</code></pre></div>
<p>This code declares the function pointer <code>add_overflow_flag</code> and then makes it point to the string which we called <code>add_overflow_flag_data</code>. This binary string is generated from the following assembly code:</p>
<div class="sourceCode"><pre class="sourceCode asm"><code class="sourceCode fasm"><span class="fu">add_overflow_flag:</span>
  <span class="bu">mov</span> <span class="kw">rax</span>, <span class="kw">rsi</span>                  <span class="co">; move x to the return register</span>
  <span class="bu">add</span> <span class="kw">rax</span>, <span class="kw">rdx</span>                  <span class="co">; add y to the return register</span>
  <span class="bu">setb</span> [<span class="kw">rdi</span>]                    <span class="co">; set b to CF</span>
  <span class="bu">ret</span></code></pre></div>
<p>If we run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">nasm</span> -f elf64 add_overflow_flag.asm
<span class="ex">objdump</span> -M intel -S add_overflow_flag.o</code></pre></div>
<p>then the output is</p>
<pre class="algorithm"><code>0000000000000000 &lt;add_overflow_flag&gt;:
   0:	48 89 f0             	mov    rax,rsi
   3:	48 01 d0             	add    rax,rdx
   6:	0f 92 07             	setb   BYTE PTR [rdi]
   9:	c3                   	ret</code></pre>
<p>which is exactly the string <code>add_overflow_flag_data</code>.</p>


  </body>
</html>
